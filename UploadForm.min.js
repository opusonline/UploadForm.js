/*!
 * UploadForm
 * file upload via xhr2 (formdata) and iframe fallback
 * supports timeout, abort, setData, setHeader, callbacks incl. beforeSend
 * heads-up: iframe responses need content-type: text/plain
 *
 * JSON polyfill: http://bestiejs.github.io/json3/
 *
 * author: Stefan Benicke <stefan.benicke@gmail.com>
 */
!function(t,e){function r(t,r,n){this.form=document.getElementById(t),this.url=r,this.options=E({},T),"object"==typeof n&&null!==n&&E(this.options,n),this.helpers={xhr:e,timer:e,formHandler:e,iframeHandler:e,messageHandler:e},this.status=e,this.response=e,this.useIFrameFallback=!S,this.busy=!1,this.headers={"X-Requested-With":S?"XMLHttpRequest":"IFrame"},this.data={},this.listener={beforesend:[],progress:[],load:[],error:[]},this.helpers.formHandler=F.add(this.form,"submit",w(i,this)),s.call(this)}function s(){var t;for(t in this.options.headers)this.options.headers.hasOwnProperty(t)&&this.setHeader(t,this.options.headers[t]);for(t in this.options.data)this.options.data.hasOwnProperty(t)&&this.setData(t,this.options.data[t])}function i(e){return e=e||t.event,e.preventDefault?e.preventDefault():e.returnValue=!1,r.prototype.send.call(this),!1}function n(){var t,e,r;x(this,"beforesend"),t=new FormData(this.form);for(e in this.data)this.data.hasOwnProperty(e)&&t.append(e,this.data[e]);r=new XMLHttpRequest,r.open("POST",this.url,!0),this.options.timeout>0&&(r.timeout=this.options.timeout);for(e in this.headers)if(this.headers.hasOwnProperty(e))try{r.setRequestHeader(e,this.headers[e])}catch(s){O(s.message)}"Accept"in this.headers||(""===this.options.type||"text"===this.options.type?r.setRequestHeader("Accept","text/plain, */*; q=0.01"):"json"===this.options.type?r.setRequestHeader("Accept","application/json, text/javascript, */*; q=0.01"):"xml"===this.options.type&&r.setRequestHeader("Accept","application/xml, text/xml, */*; q=0.01")),this.options.xhrCredentials===!0&&(r.withCredentials=!0),F.add(r.upload,"progress",w(o,this)),F.add(r,"progress",w(o,this)),F.add(r,"load",w(a,this)),F.add(r,"abort",w(l,this)),F.add(r,"error",w(h,this)),F.add(r,"timeout",w(u,this)),r.send(t),this.helpers.xhr=r}function o(t){var e="[object XMLHttpRequestUpload]"===Object.prototype.toString.call(t.target)?"upload":"download";x(this,"progress",null,null,[e,t])}function a(t){var r,s;if(r=t.target,this.helpers.xhr=e,this.busy=!1,200!==r.status)return h.apply(this,arguments);if("xml"===this.options.type)if(null!==r.responseXML)s=r.responseXML;else try{s=D(r.responseText)}catch(i){return void x(this,"error","parseerror","",["parseerror",i.message,r.responseText,r])}else if(s=r.responseText,"json"===this.options.type)try{s=JSON.parse(s)}catch(i){return void x(this,"error","parseerror","",["parseerror",i.message,r.responseText,r])}x(this,"load","success",s,[s,r])}function h(t){var r=t.target;this.helpers.xhr=e,this.busy=!1,x(this,"error","error","",["error",r.statusText,r])}function l(t){var r=t.target;this.helpers.xhr=e,this.busy=!1,x(this,"error","abort","",["abort",r])}function u(){var t=event.target;this.helpers.xhr=e,this.busy=!1,x(this,"error","timeout","",["timeout",t])}function p(){x(this,"beforesend"),d.call(this),this.form.submit(),this.options.timeout>0&&(v.call(this),this.helpers.timer=setTimeout(w(g,this),this.options.timeout))}function d(){var e,r,s;e="upload-iframe-"+H(),r=document.createElement("iframe"),r.setAttribute("src","javascript:false;"),r.setAttribute("name",e),r.setAttribute("id",e),r.setAttribute("width",0),r.setAttribute("height",0),r.setAttribute("frameborder",0),document.body.appendChild(r),r.style.display="none",window.frames&&(window.frames[e].name=e),this.options.crossDomain===!0?this.helpers.messageHandler=F.add(t,"message",w(c,this)):this.helpers.iframeHandler=F.add(r,"load",w(m,this)),this.form.setAttribute("action",this.url),this.form.setAttribute("method","POST"),this.form.setAttribute("enctype","multipart/form-data"),this.form.setAttribute("encoding","multipart/form-data"),this.form.setAttribute("target",e);for(s in this.headers)this.headers.hasOwnProperty(s)&&f.call(this,e,s,this.headers[s]);for(s in this.data)this.data.hasOwnProperty(s)&&f.call(this,e,s,this.data[s])}function m(){var t,e,r,s,i;v.call(this),t=document.getElementById(this.form.target),e=!1;try{r=t.contentWindow?t.contentWindow.document:t.contentDocument?t.contentDocument:t.document,s=r.documentElement?r.documentElement:r.body,i=s.textContent||s.innerText}catch(n){e=n.message}if(r=null,s=null,b.call(this),this.busy=!1,e!==!1)x(this,"error","error","",["error",e]);else{if("xml"===this.options.type)try{i=D(i)}catch(n){return void x(this,"error","parseerror","",["parseerror",n.message,i])}else if("json"===this.options.type)try{i=JSON.parse(i)}catch(n){return void x(this,"error","parseerror","",["parseerror",n.message,i])}x(this,"load","success",i,[i])}}function c(e){var r;if(v.call(this),b.call(this),this.busy=!1,e=e||t.event,r=e.data,"xml"===this.options.type)try{r=D(r)}catch(s){return void x(this,"error","parseerror","",["parseerror",s.message,r])}else if("json"===this.options.type)try{"[object String]"===Object.prototype.toString.call(r)&&(r=JSON.parse(r))}catch(s){return void x(this,"error","parseerror","",["parseerror",s.message,r])}x(this,"load","success",r,[r])}function f(t,e,r){var s=document.createElement("input");s.setAttribute("type","hidden"),s.setAttribute("data-uploadformid",t),s.setAttribute("name",e),s.setAttribute("value",r),this.form.appendChild(s)}function y(){v.call(this),b.call(this),this.busy=!1,x(this,"error","abort","",["abort"])}function g(){this.helpers.timer=e,b.call(this),this.busy=!1,x(this,"error","timeout","",["timeout"])}function b(){var r,s,i,n,o;for(r=document.getElementById(this.form.target),F.remove(r,"load",this.helpers.iframeHandler),this.helpers.iframeHandler=e,this.options.crossDomain===!0&&this.helpers.messageHandler&&(F.remove(t,"message",this.helpers.messageHandler),this.helpers.messageHandler=e),s=this.form.getAttribute("target"),this.form.removeAttribute("action"),this.form.removeAttribute("method"),this.form.removeAttribute("enctype"),this.form.removeAttribute("encoding"),this.form.removeAttribute("target"),document.body.removeChild(r),r=null,i=this.form.getElementsByTagName("input"),n=0;n<i.length;++n)"hidden"===i[n].type&&(o=i[n].getAttribute("data-uploadformid"),o===s&&(this.form.removeChild(i[n]),--n));i=null}function v(){"undefined"!=typeof this.helpers.timer&&(clearTimeout(this.helpers.timer),this.helpers.timer=e)}function x(t,r,s,i,n){var o,a;if(null!==s&&s!==e&&null!==i&&i!==e&&(t.status=s,t.response=i),n===e)for(t["on"+r](),o=0,a=t.listener[r].length;a>o;++o)t.listener[r][o].call(t);else for(t["on"+r].apply(t,n),o=0,a=t.listener[r].length;a>o;++o)t.listener[r][o].apply(t,n)}function w(t,e,r){return function(){var s,i,n;if("undefined"!=typeof r&&"object"==typeof r&&"length"in r){for(n=r.length,r.length+=arguments.length,s=0,i=arguments.length;i>s;++s)r[s+n]=arguments[s];return t.apply(e,r)}return t.apply(e,arguments)}}function A(){}function H(){return Math.round(1e7*Math.random())}function E(t,e){var r;for(r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function O(t){"object"==typeof console&&"warn"in console&&"function"==typeof console.warn&&console.warn(t)}var D,F,S=function(){var e=new XMLHttpRequest,r=Boolean("upload"in e&&"withCredentials"in e&&"FormData"in t);return e=null,r}(),T={timeout:0,iframe:!S,headers:{},data:{},type:"",xhrCredentials:!1,crossDomain:!1};r.useIFrameFallback=!S,r.prototype.onbeforesend=A,r.prototype.onprogress=A,r.prototype.onload=A,r.prototype.onerror=A,r.prototype.on=function(t,e){return"function"==typeof e&&t in this.listener&&this.listener[t].push(e),this},r.prototype.off=function(t,e){var r,s,i,n;if(0===arguments.length)this.listener.beforesend.length=0,this.listener.progress.length=0,this.listener.load.length=0,this.listener.error.length=0;else if("undefined"==typeof e&&t in this.listener&&this.listener[t].length>0)this.listener[t].length=0;else if("function"==typeof e&&t in this.listener&&this.listener[t].length>0){for(i=[],n=!1,r=0,s=this.listener[t].length;s>r;++r)this.listener[t]===e?n=!0:i.push(this.listener[t]);n===!0&&(this.listener[t]=i)}return this},r.prototype.send=function(t){return this.busy===!0?(O("UploadForm already sent."),this):(this.busy=!0,"object"==typeof t&&null!==t&&E(this.options,t),s.call(this),this.status=e,this.response=e,S&&this.options.iframe!==!0?n.call(this):p.call(this),this)},r.prototype.abort=function(){return this.busy!==!0?(O("Nothing to abort."),this):(S&&this.options.iframe!==!0?this.helpers.xhr&&"abort"in this.helpers.xhr&&this.helpers.xhr.abort():y.call(this),this)},r.prototype.unbindFormSubmit=function(){return this.form&&this.helpers.formHandler&&(F.remove(this.form,"submit",this.helpers.formHandler),this.helpers.formHandler=e),this},r.prototype.destruct=function(){return this.busy===!0?(O("Destruct failed. UploadForm currently in use."),this):(this.unbindFormSubmit(),v.call(this),this.form=e,this.helpers.xhr=e,this.helpers.iframeHandler=e,this.helpers.messageHandler=e,this.onbeforesend=e,this.onprogress=e,this.onload=e,this.onerror=e,this.listener.beforesend.length=0,this.listener.progress.length=0,this.listener.load.length=0,this.listener.error.length=0,this)},r.prototype.setData=function(t,r){return t===e||null===t||""+t==""?(O("Append data failed: invalid name"),this):(t+="",r+="",this.data[t]=r,this)},r.prototype.setHeader=function(t,r){return t===e||null===t||""+t==""?void O("Append header failed: invalid name"):(t+="",r+="",void(this.headers[t]=r))},t.UploadForm=r,function(t){"use strict";var e=t.prototype,r=e.parseFromString;try{if((new t).parseFromString("","text/html"))return}catch(s){}e.parseFromString=function(t,e){if(/^\s*text\/html\s*(?:;|$)/i.test(e)){var s=document.implementation.createHTMLDocument("");return t.toLowerCase().indexOf("<!doctype")>-1?s.documentElement.innerHTML=t:s.body.innerHTML=t,s}return r.apply(this,arguments)}}(DOMParser),D=function(){var t=(new DOMParser).parseFromString("INVALID","text/xml").getElementsByTagName("parsererror")[0].namespaceURI;return function(e){var r=(new DOMParser).parseFromString(e,"text/xml");if(r.getElementsByTagNameNS(t,"parsererror").length>0)throw new Error("Error parsing XML");return r}}(),F=function(t){var e={};return document.addEventListener?(e.add=function(t,e,r,s){return t.addEventListener(e,r,!!s),r},e.remove=function(t,e,r,s){return t.removeEventListener(e,r,!!s),!0}):document.attachEvent?(e.add=function(t,e,r){var s;return e="on"+e,s=function(){return r.apply(t,arguments)},t.attachEvent(e,s),s},e.remove=function(t,e,r){return e="on"+e,t.detachEvent(e,r),!0}):(e.add=function(t,e,r){var s,i;return e="on"+e,t.memorize=t.memorize||{},t.memorize[e]||(t.memorize[e]="function"==typeof t[e]?{id:1,handler:{func1:t[e]}}:{id:0,handler:{}},t[e]=function(){var t;for(t in s.handler)s.handler.hasOwnProperty(t)&&"function"==typeof s.handler[t]&&s.handler[t].apply(this,arguments)}),s=t.memorize[e],s.id++,i="func"+s.id,s.handler[i]=r,i},e.remove=function(e,r,s){return r="on"+r,e.memorize&&e.memorize[r]&&e.memorize[r].handler[s]&&(e.memorize[r].handler[s]=t),!0}),e}()}(this);